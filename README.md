# Secure MQTT

Java implementation of a MQTT extension for providing end-to-end (E2E) security to MQTT applications.

This is in contrast with the classical MQTT usage where communication security requires high trust in the MQTT broker. In fact in standard MQTT, regardless TCP or TLS is used for the client-to-broker communications, the broker has full visibility of all data that is exchanged between clients.

To provide real E2E security without the need to trust the MQTT broker, the exchanged data must be protected E2E at application level.

In order to support one-to-many communications, naturally provided by MQTT through the publish/subscribe paradigm, data encryption should be performed using a symmetric group key, shared only amongst the communication group members.

For making the group key securerly shared amogst different clients a proper group key management mechanism is required.
In particular, the Secure MQTT protocol here implemented performs group key management based on the presence of a Key Server.

For MQTT communications the Eclipse Paho library has been used.


## Simple test

This implementation can be easily tested also by launching the test.SMqttTest program that runs a Key Server and n SMQTT clients. One of the three GKD methods can be selected (default is 2=update).
By default it expects a standard MQTT broker locally running at 127.0.0.1:1883, however the broker address can be explcitely configured using the ‘-b’ option.

To run the test, open a terminal and execute the following command:
``` bash
java -cp "java/lib/*" test.SMqttTest -v
```
### Dependencies

The following libraries are required and included in the /java/lib folder:
* [zutil](https://github.com/zoolu-org/zutil) - it is a collection of some utilities; in particular ipstack Lorawan uses zutil for managing command line options, for handling byte arrays, as JSON parser, and for handling logs.
* [ipstack](https://github.com/ipstack-dev/ipstack) - it is mainly a TCP/IP library; however it provides also generic support for handling packets aat different protocol layer.
* [paho-mqtt](https://github.com/eclipse-paho/paho.mqtt.java) - Eclipse Java library providing the implementation of both MQTT v3.1 and MQTT v5.0.



## Key Server

The implemented Key Server actually supports three different group key management mechanisms:

* STATIC - For each group a static group key is generated by the GKDC and distributed to each authorized client that requests to join the group.

* UPDATE - for each group a group key is distributed by the GKDC to authorized client. Each time a new client requests to join the group, a new key is generated and distributed to all members of the group (including the previous clients and the new client).
Similarly, each time a member leaves the group, a new key is generated and distributed to all remaining members.

* SLOTTED - For each group a dynamic key is considered. Differently from the previous methods, the time is divided in time slots, and for each time slot a different key is defined.
In order to manage possible big numbers of time slots and corresponding keys, a dynamic auto-generating mechanism is considered. The mechanism is similar to the one proposed in [1].

All commuications for group key distribution are performed using MQTT. A specific key distribution protocol have been defined for this purpose.

The Key Server can be run on a Java 10+ JVM. It just requires a standard MQTT (e.g. Eclipse mosquitto) running and reachable at a given IP address:
``` bash
java -cp "java/lib/*" test.KeyServerMain -v
```

By default it expects the MQTT broker running locally at 127.0.0.1:1883, however the broker address can be explicitly configured using the ‘-b’ option.

All command-line options can be shown using the ‘-h’ option.



## Secure MQTT Client

When the MQTT broker and Key Server are up, you can run a SMQTT client as follows:
``` bash
java -cp "java/lib/*" test.SMqttClientMain -v
```

This command runs a test SMQTT client that joins a group (default is 'test') and waits for incoming messages or for input messages to be sent (typed at the prompt).

By default it expects the MQTT broker running locally at 127.0.0.1:1883, however the broker address can be explicitly configured using the ‘-b’ option.

Use '-h' option to show all command-line options.



## References

[1] L. Veltri et al, "A novel batch-based group key management protocol applied to the Internet of Things", Ad Hoc Networks, Volume 11, Issue 8, November 2013, pages 2724-2737.
